using UnityEngine;

public class GameManager : MonoBehaviour
{
    GameObject emptyObject;
    GameObject uiRoot;    

    UIManager uiManager;
    PlayerManager playerManager;
    LifeManager lifeManager;
    ObstacleManager obstacleManager;

    PlayerData playerData;

    private void Awake()
    {
        // 화면 안꺼지게 설정
        Utility.NoSleepMode(); 

        DontDestroyOnLoad(uiRoot = Share.Util.InstantiatePrefab(Share.Path.Prefab.Root, null));

        // 데이터 불러오기
        playerData = Resources.Load("ScriptableObject/Player Data") as PlayerData;

        // 모든 매니저 생성
        playerManager = new PlayerManager();
        lifeManager = new LifeManager();
        lifeManager.Init(playerData.life, playerData.maxLife);
        uiManager = new UIManager();
        uiManager.UISetting(lifeManager.GetMaxLife());
        obstacleManager = new ObstacleManager();
    }

    void FixedUpdate()
    {
        switch (uiManager.GetState())
        {
            case UIManager.State.TITLE: // 타이틀 화면
                // 메인캔버스가 활성화 되어있을 때
                if (Utility.FindVisibleGameobjectWithName(emptyObject, "MaingameCanvas") != null)
                {                    
                    // 플레이어 생성
                    playerManager.Init(playerData.speed);
                    // 장애물 생성
                    obstacleManager.Init();
                    obstacleManager.Generate(obstacleManager.GetObstacleNum());
                    uiManager.GetMaingameUI().SetHeartActive(lifeManager.GetLife(), lifeManager.GetMaxLife());
                    // 상태 변경
                    uiManager.SetState(UIManager.State.MAINGAME);
                }
                break;
            case UIManager.State.MAINGAME: // 메인 게임 플레이 화면
                // 플레이어 이동
                playerManager.GetPlayer().GetPlayerController().Move();
                // 점수 변동
                uiManager.GetMaingameUI().SetScoreText();                
                // 10점 오를때마다 장애물 1개 추가 생성
                if (((int)uiManager.GetMaingameUI().GetScore() / playerData.monsterDelay) == obstacleManager.GetObstacleNum())
                    obstacleManager.Generate(obstacleManager.GetObstacleNum());
                // 장애물 이동
                obstacleManager.Moving(obstacleManager.GetObstacleNum(), playerManager.GetPlayer().GetPlayerGameObject(), lifeManager, uiManager);
                // 플레이어 체력 0일 경우
                if (lifeManager.GetLife() <= 0)
                {                    
                    // 생성한 장애물 파괴
                    obstacleManager.DestroyObject();
                    // 결과창 띄우기
                    Utility.Visible(uiManager.GetResultUI().GetGameObject());
                    // 게임 멈추기
                    Utility.Pause();
                    // 상태 변경
                    uiManager.SetState(UIManager.State.RESULT);
                }
                break;
            case UIManager.State.RESULT: // 결과창 화면
                // 결과창캔버스가 비활성화 되어있을 경우
                if (Utility.FindVisibleGameobjectWithName(emptyObject, "ResultCanvas") == null)
                {                    
                    // 플레이어 초기화
                    playerManager.Reset();
                    // 장애물 초기화 및 재생성
                    obstacleManager.ResetObstacleNum();
                    obstacleManager.Generate(obstacleManager.GetObstacleNum());
                    // 플레이어 체력 초기화
                    lifeManager.ResetLife(playerData.life);
                    // UI 초기화
                    uiManager.GetMaingameUI().SetHeartActive(lifeManager.GetLife(), lifeManager.GetMaxLife());
                    uiManager.GetMaingameUI().ResetScore();
                    // 상태 변경
                    uiManager.SetState(UIManager.State.MAINGAME);
                }
                break;                
        }
    }
}
